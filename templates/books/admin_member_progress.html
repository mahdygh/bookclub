{% extends 'base.html' %}
{% load static %}

{% block title %}وضعیت مطالعه اعضا - پنل ادمین{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-users"></i>
                        وضعیت مطالعه اعضا
                    </h3>
                    <div class="card-tools">
                        <span class="badge badge-info">{{ total_members }} عضو فعال</span>
                        <span class="badge badge-success">{{ total_books }} کتاب</span>
                    </div>
                </div>
                <div class="card-body">
                    {% if active_period %}
                        <div class="alert alert-info">
                            <h5><i class="fas fa-info-circle"></i> دوره فعال: {{ active_period.name }}</h5>
                            <p>{{ active_period.description }}</p>
                            <small>از {{ active_period.start_date|date:"Y/m/d" }} تا {{ active_period.end_date|date:"Y/m/d" }}</small>
                        </div>
                        
                        {% if member_details %}
                            <div class="row">
                                {% for detail in member_details %}
                                    <div class="col-lg-4 col-md-6 mb-3">
                                        <div class="card border-left-primary member-card" 
                                             data-member-id="{{ detail.member.id }}"
                                             style="cursor: pointer;">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-3">
                                                    <div>
                                                        <h5 class="mb-1">
                                                            <i class="fas fa-user text-primary"></i>
                                                            {{ detail.member.full_name }}
                                                        </h5>
                                                        <small class="text-muted">
                                                            امتیاز کل: {{ detail.member.total_score }}
                                                        </small>
                                                    </div>
                                                    <span class="badge badge-primary">
                                                        {{ detail.completed_assignments }}/{{ detail.total_assignments }}
                                                    </span>
                                                </div>
                                                
                                                <!-- اطلاعات مرحله -->
                                                {% if detail.stage %}
                                                    <div class="mb-3">
                                                        <h6 class="text-primary mb-1">
                                                            <i class="fas fa-layer-group"></i>
                                                            {{ detail.stage.name }}
                                                        </h6>
                                                        <small class="text-muted">{{ detail.stage.description|truncatechars:50 }}</small>
                                                    </div>
                                                    
                                                    <!-- نوار پیشرفت -->
                                                    <div class="mb-3">
                                                        <div class="d-flex justify-content-between mb-1">
                                                            <span>پیشرفت:</span>
                                                            <span>{{ detail.progress_stats.progress_percentage }}%</span>
                                                        </div>
                                                        <div class="progress" style="height: 8px;">
                                                            <div class="progress-bar bg-success" 
                                                                 style="width: {{ detail.progress_stats.progress_percentage }}%">
                                                            </div>
                                                        </div>
                                                        <small class="text-muted">
                                                            {{ detail.progress_stats.completed_books }} از {{ detail.progress_stats.total_books_in_stage }} کتاب
                                                        </small>
                                                    </div>
                                                    
                                                    <!-- وضعیت پیشرفت -->
                                                    {% if detail.progress_stats.can_advance %}
                                                        <div class="alert alert-success alert-sm mb-0">
                                                            <i class="fas fa-check-circle"></i>
                                                            آماده برای مرحله بعد
                                                        </div>
                                                    {% else %}
                                                        <div class="alert alert-warning alert-sm mb-0">
                                                            <i class="fas fa-clock"></i>
                                                            در حال مطالعه
                                                        </div>
                                                    {% endif %}
                                                {% else %}
                                                    <div class="alert alert-secondary alert-sm mb-0">
                                                        <i class="fas fa-exclamation-triangle"></i>
                                                        مرحله‌ای تعیین نشده
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Modal برای نمایش جزئیات -->
                            <div class="modal fade" id="memberDetailsModal" tabindex="-1">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">
                                                <i class="fas fa-user"></i>
                                                <span id="modalMemberName"></span>
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div id="modalContent">
                                                <!-- محتوا از طریق JavaScript پر می‌شود -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                هیچ عضو فعالی یافت نشد.
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i>
                            هیچ دوره فعالی یافت نشد. لطفاً ابتدا یک دوره کتابخوانی فعال کنید.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.border-left-primary {
    border-left: 4px solid #007bff !important;
}

.card {
    box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
    margin-bottom: 1rem;
}

.progress {
    height: 8px;
}

.alert-sm {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
}

.list-group-item {
    border: none;
    padding: 0.5rem 0;
}

.badge {
    font-size: 0.75rem;
}

/* اصلاح رنگ متن */
.card-header h5,
.card-header h6,
.card-body h5,
.card-body h6,
.card-body strong,
.card-body .text-primary,
.card-body .text-success,
.card-body .text-warning,
.card-body .text-muted {
    color: #333 !important;
}

.card-header {
    background-color: #f8f9fa !important;
    color: #333 !important;
    border-bottom: 1px solid #dee2e6;
}

.card-body {
    background-color: #fff !important;
    color: #333 !important;
}

.card-footer {
    background-color: #f8f9fa !important;
    border-top: 1px solid #dee2e6;
}

/* اصلاح رنگ لینک‌ها */
a {
    color: #007bff !important;
}

a:hover {
    color: #0056b3 !important;
}

/* اصلاح رنگ متن در alert ها */
.alert {
    color: #333 !important;
}

.alert-success {
    background-color: #d4edda !important;
    border-color: #c3e6cb !important;
    color: #155724 !important;
}

.alert-warning {
    background-color: #fff3cd !important;
    border-color: #ffeaa7 !important;
    color: #856404 !important;
}

.alert-info {
    background-color: #d1ecf1 !important;
    border-color: #bee5eb !important;
    color: #0c5460 !important;
}

.alert-danger {
    background-color: #f8d7da !important;
    border-color: #f5c6cb !important;
    color: #721c24 !important;
}

.alert-secondary {
    background-color: #e2e3e5 !important;
    border-color: #d6d8db !important;
    color: #383d41 !important;
}

/* استایل کارت عضو */
.member-card {
    transition: all 0.3s ease;
}

.member-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
}

.member-card:active {
    transform: translateY(0);
}

/* اصلاح مشکلات modal */
.modal {
    overflow-x: hidden;
}

.modal-dialog {
    max-width: 90vw;
    margin: 1rem auto;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
}

.modal-content {
    border-radius: 0.5rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    max-height: 90vh;
    display: flex;
    flex-direction: column;
}

.modal-header {
    flex-shrink: 0;
    border-bottom: 1px solid #dee2e6;
}

.modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    max-height: calc(90vh - 120px);
}

.modal-footer {
    flex-shrink: 0;
    border-top: 1px solid #dee2e6;
}

/* اصلاح مشکلات responsive */
@media (max-width: 768px) {
    .modal-dialog {
        max-width: 95vw;
        margin: 0.5rem auto;
        max-height: 95vh;
    }
    
    .modal-body {
        max-height: calc(95vh - 100px);
        padding: 1rem;
    }
}

/* جلوگیری از اسکرول افقی */
body.modal-open {
    overflow: hidden;
    padding-right: 0 !important;
}

/* اصلاح مشکلات اسکرول */
.modal-body::-webkit-scrollbar {
    width: 6px;
}

.modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.modal-body::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* اصلاح list-group */
.list-group-item {
    border: 1px solid #dee2e6;
    margin-bottom: 0.5rem;
    border-radius: 0.375rem;
    padding: 0.75rem;
}

.list-group-item:last-child {
    margin-bottom: 0;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // کلیک روی کارت عضو
    document.querySelectorAll('.member-card').forEach(card => {
        card.addEventListener('click', function() {
            const memberId = this.getAttribute('data-member-id');
            showMemberDetails(memberId);
        });
    });
});

async function showMemberDetails(memberId) {
    // نمایش loading
    document.getElementById('modalMemberName').textContent = 'در حال بارگذاری...';
    document.getElementById('modalContent').innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">در حال بارگذاری اطلاعات...</p></div>';
    
    // نمایش modal
    const modalElement = document.getElementById('memberDetailsModal');
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: 'static',
        keyboard: true
    });
    modal.show();
    
    // دریافت اطلاعات عضو از سرور
    const memberData = await getMemberData(memberId);
    
    // نمایش نام عضو در modal
    document.getElementById('modalMemberName').textContent = memberData.name;
    
    // ایجاد محتوای modal
    let content = `
        <div class="row g-3">
            <div class="col-12">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-check-circle"></i>
                            کتاب‌های خوانده شده (${memberData.completed_books.length})
                        </h6>
                    </div>
                    <div class="card-body p-2">
    `;
    
    if (memberData.completed_books.length > 0) {
        memberData.completed_books.forEach(book => {
            content += `
                <div class="d-flex justify-content-between align-items-center p-2 mb-2 bg-light rounded">
                    <div class="flex-grow-1">
                        <strong class="d-block">${book.title}</strong>
                        <small class="text-muted">${book.author}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-success">${book.score} امتیاز</span>
                        <br>
                        <small class="text-muted">${book.returned_date}</small>
                    </div>
                </div>
            `;
        });
    } else {
        content += '<div class="text-center text-muted py-3">هیچ کتابی خوانده نشده است</div>';
    }
    
    content += `
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-clock"></i>
                            کتاب‌های نخوانده (${memberData.uncompleted_books.length})
                        </h6>
                    </div>
                    <div class="card-body p-2">
    `;
    
    if (memberData.uncompleted_books.length > 0) {
        memberData.uncompleted_books.forEach(book => {
            content += `
                <div class="d-flex justify-content-between align-items-center p-2 mb-2 bg-light rounded">
                    <div class="flex-grow-1">
                        <strong class="d-block">${book.title}</strong>
                        <small class="text-muted">${book.author}</small>
                    </div>
                    <div class="text-end">
                        ${book.assignment ? 
                            `<span class="badge bg-warning text-dark">در انتظار</span><br><small class="text-muted">موعد: ${book.due_date}</small>` :
                            `<span class="badge bg-secondary">امانت نگرفته</span>`
                        }
                    </div>
                </div>
            `;
        });
    } else {
        content += '<div class="text-center text-muted py-3">همه کتاب‌ها خوانده شده است</div>';
    }
    
    content += `
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('modalContent').innerHTML = content;
}

async function getMemberData(memberId) {
    try {
        const response = await fetch(`/api/member/${memberId}/details/`);
        if (!response.ok) {
            throw new Error('خطا در دریافت اطلاعات');
        }
        return await response.json();
    } catch (error) {
        console.error('خطا:', error);
        return {
            name: 'خطا در دریافت اطلاعات',
            completed_books: [],
            uncompleted_books: []
        };
    }
}
</script>
{% endblock %}
